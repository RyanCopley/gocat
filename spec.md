# Gocat Formal Specification

**Version:** 0.1  
**Date:** 2025-02-18  
**Author:** Ryan Copley

---

## 1. Overview

**Gocat** is a command-line tool written in Go that bundles multiple files into a single output stream and later splits that stream back into the original files. It is designed primarily for Go source files, but also supports non-Go files. For Go files, gocat recursively follows internal module dependencies (as defined in the `go.mod` file) and includes all associated files. The output uses clearly defined delimiters and begins with a mandatory "magic header" to identify the file format and version.

---

## 2. Purpose and Scope

### 2.1 Purpose

- **Bundling:** Combine multiple Go source files (and related non-Go files) into a single stream.
- **Dependency Resolution:** Parse Go files for import statements and recursively include associated internal module files.
- **Splitting:** Reconstruct the original file hierarchy from a bundled stream using embedded delimiters and a magic header.

### 2.2 Scope

- **Input:**  
  - Files and glob patterns provided via command-line arguments.
  - A valid `go.mod` file in the current working directory for module name extraction.
- **Processing:**  
  - For **Go source files** (`*.go`):
    - Output the file contents wrapped with header and footer delimiters.
    - Parse the file for import statements (using Go’s parser) and recursively include files from packages within the same module.
  - For **non-Go files**:
    - Simply output the file with header and footer delimiters without further recursive processing.
- **Output:**  
  - A single concatenated text stream that begins with a magic header.
  - Each file is delimited with a header and footer that include metadata.
- **Splitting:**  
  - The tool validates the magic header and then uses the embedded delimiters to re-create the original file hierarchy.

---

## 3. Terminology and Definitions

- **Gocat:** The name of the program.
- **Magic Header:** A mandatory first line in the bundled output that identifies the file as produced by gocat.  
  **Format:**  
  ```
  // --------- gocat v1
  ```
- **File Delimiter:** Special lines inserted before and after each file’s contents.
  - **Header Delimiter:**  
    ```
    // --------- FILE START: "relative/path/to/file" (size: X bytes, modtime: TIMESTAMP) ----------
    ```
  - **Footer Delimiter:**  
    ```
    // --------- FILE END: "relative/path/to/file" ----------
    ```
- **Module Name:** The identifier for the Go module as defined in the `go.mod` file.
- **Processed File:** A file that has already been included in the bundle (tracked via its absolute path) to avoid duplication.

---

## 4. System Architecture

Gocat is a command-line tool with three main subcommands:
1. **join:** Bundles files (and recursively includes Go dependencies) into a single stream.
2. **split:** Splits a bundled output back into individual files.
3. **help:** Displays usage information.

Gocat uses Go’s standard libraries for file I/O, command-line flag parsing, and source code parsing (via `go/parser`).

---

## 5. Functional Requirements

### 5.1 General Requirements

- **Startup:**  
  - When invoked, gocat must validate that at least one subcommand is provided.
- **Magic Header (Join):**  
  - The very first line of the output generated by the join command must be the magic header:
    ```
    // --------- gocat v1
    ```
- **Subcommand Handling:**  
  - Supported subcommands: `join`, `split`, and `help`.
- **Error Reporting:**  
  - Errors must be reported to standard error, and the program must exit with a non-zero status code for fatal errors.

### 5.2 Join Command Requirements

- **Command Syntax:**  
  ```
  gocat join [file or glob pattern] ...
  ```
- **Module Resolution:**  
  - Gocat shall read the `go.mod` file from the current directory and extract the module name from a line starting with `module `.
- **Magic Header Output:**  
  - Before any file processing begins, output the magic header (`// --------- gocat v1`) as the first line.
- **File Processing:**  
  - For each file (or glob pattern match):
    - **Go Files:**  
      - Print a header delimiter, output the file content, then print a footer delimiter.
      - Parse the file for import statements and recursively process files in packages with import paths that begin with the module name.
    - **Non-Go Files:**  
      - Print a header delimiter, output the file content, then print a footer delimiter.
      - No further processing is performed.
  - **Duplication Avoidance:**  
    - Use a tracking mechanism (e.g., a map keyed by absolute file path) to ensure each file is included only once.
- **Exclusion Options:**  
  - The join command shall support two optional flags:
    - **`-exclude-packages`:** Accepts a comma-separated list of package names. For any Go file processed, if the file’s package declaration (extracted using a package clause parser) matches any of the specified names, the file is skipped and its dependencies are not processed.
    - **`-exclude-files`:** Accepts a comma-separated list of glob patterns. Any file whose relative path matches one of these patterns is skipped from processing.

### 5.3 Split Command Requirements

- **Command Syntax:**  
  ```
  gocat split [-in inputfile] [-out outputdirectory]
  ```
- **Input Handling:**  
  - If `-in` is provided, read from the specified file; otherwise, read from standard input.
- **Magic Header Validation:**  
  - The first line of the input must match the magic header exactly (`// --------- gocat v1`). If not, the split process must abort with an error.
- **File Extraction:**  
  - Read the input line-by-line.
  - Upon encountering a header delimiter, extract the file name and create the necessary output file (within the specified output directory, if any).
  - Continue writing subsequent lines until the corresponding footer delimiter is encountered.
  - Close the file and resume processing the next file.
- **Output Directory Safety:**  
  - Validate that output paths remain within the designated output directory to prevent directory traversal vulnerabilities.

### 5.4 Help Command Requirements

- **Command Syntax:**  
  ```
  gocat help [subcommand]
  ```
- **Behavior:**  
  - With no additional argument, display general usage and list available subcommands.
  - With a subcommand specified (e.g., `join` or `split`), display detailed help for that subcommand.

---

## 6. Non-Functional Requirements

- **Performance:**  
  - The tool should efficiently handle a moderate number of files (tens to hundreds) without noticeable delays.
- **Portability:**  
  - Gocat must compile and run on all platforms supported by Go.
- **Maintainability:**  
  - The code must be modular with clear separation between file processing, CLI handling, and splitting logic.
- **Usability:**  
  - Provide clear help messages and informative error messages.

---

## 7. Detailed Design

### 7.1 Data Structures

- **Processed Files Map:**  
  - Type: `map[string]bool` (keyed by absolute file path) to ensure no file is processed more than once.
- **Delimiter Strings:**  
  - **Magic Header:**  
    ```
    "// --------- gocat v1"
    ```
  - **File Start Delimiter:**  
    ```
    "// --------- FILE START: \"relative/path/to/file\" (size: X bytes, modtime: TIMESTAMP) ----------"
    ```
  - **File End Delimiter:**  
    ```
    "// --------- FILE END: \"relative/path/to/file\" ----------"
    ```

### 7.2 Algorithms

#### 7.2.1 Join Command Algorithm

1. **Output Magic Header:**  
   - Write the magic header (`// --------- gocat v1`) as the first line.
2. **Module Name Retrieval:**  
   - Open and parse `go.mod` to extract the module name.
3. **Process Each File/Pattern:**  
   - For each command-line argument (after glob expansion):
     - Normalize and check if the file has already been processed.
     - If it is a Go file:
       - Print the header delimiter.
       - Output the file contents.
       - Print the footer delimiter.
       - Re-open and parse for import statements.
       - For each import starting with the module name, recursively process files in that package.
     - If it is a non-Go file:
       - Print the header delimiter.
       - Output the file contents.
       - Print the footer delimiter.
4. **Duplication Avoidance:**  
   - Maintain a set of processed file paths to avoid duplicates.
5. **Exclusion Checks:**  
   - Prior to processing a file, check its relative path against the glob patterns provided via the `-exclude-files` flag.
   - For Go files, extract the package declaration and skip processing if it matches any package name provided via the `-exclude-packages` flag.

#### 7.2.2 Split Command Algorithm

1. **Read and Validate Magic Header:**  
   - Read the first line and ensure it matches the expected magic header.
2. **Line-by-Line Processing:**  
   - For each subsequent line:
     - If a header delimiter is encountered:
       - Parse the file name.
       - Create the output file (ensuring the path is within the designated output directory).
     - Write lines to the file until a matching footer delimiter is encountered.
     - Close the file upon encountering the footer delimiter.
3. **Error Handling:**  
   - Log errors for malformed delimiters or file I/O issues and continue processing where possible.

### 7.3 Command-Line Interface (CLI)

- **Usage:**  
  ```
  gocat <command> [options] [arguments]
  ```
- **Subcommands:**
  - `join` – Bundles files into a single stream.
  - `split` – Splits a bundled stream into individual files.
  - `help` – Displays usage information.
- **Examples:**
  - **Join:**  
    ```
    gocat join "main.go" "assets/*" -exclude-packages="expressions,lexer" -exclude-files="vendor/*,testdata/*"
    ```
  - **Split:**  
    ```
    gocat split -in joined.txt -out outputFolder
    ```
  - **Help:**  
    ```
    gocat help join
    ```

---

## 8. Error Handling and Reporting

- **Module Retrieval:**  
  - If `go.mod` is missing or the module name cannot be extracted, output a fatal error.
- **File Access:**  
  - Report errors for inaccessible files and continue processing other files.
- **Glob Patterns:**  
  - Log warnings for invalid or non-matching glob patterns.
- **Magic Header (Split):**  
  - Abort splitting if the first line does not match the magic header.
- **Delimiter Parsing:**  
  - Log and skip malformed header or footer delimiters.
- **Output Directory Validation:**  
  - Ensure that files are created only within the specified output directory, logging errors otherwise.
